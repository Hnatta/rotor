#!/bin/sh /etc/rc.common
START=95
STOP=05
USE_PROCD=1
PROG="/usr/bin/oc-rotor.sh"
ENVFILE="/etc/oc-rotor.env"

load_env() {
	CTRL="${CTRL:-http://127.0.0.1:9090}"
	SECRET="${SECRET:-}"
	GROUPS="${GROUPS:-SGR_ACTIVE IDN_ACTIVE WRD_ACTIVE}"
	PING_URL="${PING_URL:-https%3A%2F%2Fwww.youtube.com%2Fgenerate_204}"
	TIMEOUT_MS="${TIMEOUT_MS:-3000}"
	STEP_SEC="${STEP_SEC:-1}"
	RECHECK_SEC="${RECHECK_SEC:-30}"
	FAIL_FAST_RETRIES="${FAIL_FAST_RETRIES:-3}"
	FAIL_FAST_BACKOFF_SEC="${FAIL_FAST_BACKOFF_SEC:-1}"
	MODEM_CMD="${MODEM_CMD:-/usr/bin/modem ip}"
	STATE_DIR="${STATE_DIR:-/tmp/oc-rotor}"
	[ -f "$ENVFILE" ] && . "$ENVFILE"
}

start_service() {
	[ -x "$PROG" ] || { echo "oc-rotor: $PROG tidak ditemukan/eksekusi"; return 1; }
	load_env
	procd_open_instance
	procd_set_param command "$PROG"
	procd_set_param env CTRL="$CTRL" SECRET="$SECRET" GROUPS="$GROUPS" \
		PING_URL="$PING_URL" TIMEOUT_MS="$TIMEOUT_MS" STEP_SEC="$STEP_SEC" \
		RECHECK_SEC="$RECHECK_SEC" FAIL_FAST_RETRIES="$FAIL_FAST_RETRIES" \
		FAIL_FAST_BACKOFF_SEC="$FAIL_FAST_BACKOFF_SEC" MODEM_CMD="$MODEM_CMD" \
		STATE_DIR="$STATE_DIR"
	procd_set_param stdout 1
	procd_set_param stderr 1
	procd_set_param respawn 300 5 5
	procd_set_param nice 10
	procd_close_instance
}

reload_service() { stop; start; }
service_triggers() { :; }
